# Kafka

Pull-model - когда клиент сам забирает данные из брокера. Kafka ничего не отправляет сама.

# link

    https://dzone.com/articles/how-to-deploy-apache-kafka-with-kubernetes


```bash

kubectl apply -f 00-namespace.yaml
kubectl apply -f 01-zookeper.yaml
kubectl apply -f 02-kafka.yaml

# открыть порт для доступа к kafka извне
kubectl port-forward kafka-broker-d4fb477fd-7kwmw 9092 -n kafka 

# писать в топик test
kcat -P -b localhost:9092 -t test

# читать из топика test
kcat -C -b localhost:9092 -t test

```


### Создание топика и партиций
Лучше создавать минимум 4 партиции на сервис, чтобы можно было масштабировать сервис.


```bash
# создать топик test с 3 партициями
kafka-topics.sh --create --topic test --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092
```    

# Delivery guarantees - гарантии доставки
### Проблемы
* Одно сообщение может быть отправлено в несколько раз.
* Сообщения могут быть отправлены/прочитаны в неправильном порядке.
* Broker может получить сообщение, отправить подтверждение, но не смочь записать сообщение в топик.

### Пути решения проблем
На стороне продюсера:
```
acks>0
log.flush.interval.messages сделать меньше, чтобы чаще флашить данные на диск
replication.factor увеличить, чтобы было больше реплик
```

## At least once
Помогает **избежать потери данных**, но может привести к **дублированию данных**.

Помогает при ситуации, когда отказало соединение между продюсером и брокером.
Не поможет если брокер упал после того, как отправил подтверждение, но до того, как записал сообщение в топик.

Разрешается с помощью:
```
acks>0 и переотправки сообщений, если не получено подтверждение от брокера.
```

## At most once
**Не отсылать сообщение если получили ошибку.**


Помогает **избежать дублирования данных**, но может привести к **потере данных**.
Сообщение точно потеряется при разрыве соединения между продюсером и брокером.

Разрешается с помощью:
```
acks=0
```


## Exactly once
**Отправить сообщение только один раз.**
Сообщение будет отправлено только один раз и прочитано только один раз.
Работает медленнее, чем at least once и at most once.


# Idempotent
Это когда одно и то же сообщение отправляется несколько раз, но в итоге сохраняется только одна копия.

```
enable.idempotence=true
acks=all
```

### Локальная идепотентность
Можно реализовать с помощью ключа сообщения.

